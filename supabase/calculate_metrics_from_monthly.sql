-- ========================================
-- æœˆæ¬¡ãƒžãƒ¼ã‚¸ã‚·ãƒ¼ãƒˆã‹ã‚‰å–¶æ¥­é€²æ—æŒ‡æ¨™ã‚’è¨ˆç®—ã™ã‚‹SQL
-- æ‹…å½“ã€åˆå›žã€é¢æŽ¥ã€æˆç´„ã®æ­£ç¢ºãªè¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯
-- ========================================
-- ã“ã®SQLã¯è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã®å‚è€ƒç”¨ã§ã™
-- å®Ÿéš›ã®é›†è¨ˆã¯ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¾ãŸã¯APIã§å®Ÿè£…ã—ã¦ãã ã•ã„

-- ========================================
-- è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯å®šç¾©ï¼ˆä¾‹ï¼šç€§æ¾¤ã€2026å¹´1æœˆã®å ´åˆï¼‰
-- ========================================

-- 1. æ‹…å½“ï¼ˆæ‹…å½“ä»¶æ•°ï¼‰
-- æ¡ä»¶: æ‹…å½“è€…ãŒç€§æ¾¤ã‹ã¤ã€å‰²ã‚ŠæŒ¯ã‚Šæ—¥ãŒå½“æœˆï¼ˆ2026å¹´1æœˆï¼‰ã®æ•°
SELECT 
  member_name as æ‹…å½“è€…,
  COUNT(DISTINCT candidate_id) as æ‹…å½“æ•°
FROM stg_member_monthly
WHERE month_text = '2026_01'
  AND member_name = 'ç€§æ¾¤'
  AND assigned_date IS NOT NULL
  AND assigned_date != ''
  -- å‰²ã‚ŠæŒ¯ã‚Šæ—¥ãŒ2026å¹´1æœˆã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
  AND (
    assigned_date LIKE '2026/1/%' OR
    assigned_date LIKE '2026/01/%' OR
    TO_DATE(assigned_date, 'YYYY/MM/DD') >= '2026-01-01'::DATE
    AND TO_DATE(assigned_date, 'YYYY/MM/DD') < '2026-02-01'::DATE
  )
GROUP BY member_name;

-- 2. åˆå›žï¼ˆåˆå›žé€£çµ¡æ¸ˆã¿ï¼‰
-- æ¡ä»¶: æ‹…å½“è€…ãŒç€§æ¾¤ã‹ã¤ã€å‰²ã‚ŠæŒ¯ã‚Šæ—¥ãŒå½“æœˆã‹ã¤ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒä»¥ä¸‹ã®ã„ãšã‚Œã‹
-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒªã‚¹ãƒˆ:
--   ðŸŸ£ ææ¡ˆæ±‚äººé¸å®šä¸­
--   ðŸŸ¤ æ±‚äººææ¡ˆæ¸ˆï¼ˆè¿”ä¿¡å¾…ã¡ï¼‰
--   ðŸŸ¢ æ›¸é¡žé¸è€ƒä¸­
--   ðŸŸ¢ é¢æŽ¥æ—¥ç¨‹èª¿æ•´ä¸­
--   ðŸŸ¢ é¢æŽ¥ç¢ºå®šæ¸ˆ
--   ðŸŸ  é¢æŽ¥å®Ÿæ–½æ¸ˆï¼ˆçµæžœå¾…ã¡ï¼‰
--   ðŸŸ£ å†…å®šç²å¾—ï¼ˆæ‰¿è«¾ç¢ºèªä¸­ï¼‰
--   ðŸŸ¢ å†…å®šæ‰¿è«¾ï¼ˆæˆç´„ï¼‰
--   ðŸ”´ å†…å®šè¾žé€€
--   âšª éŸ³ä¿¡ä¸é€š
--   âšª è¿½å®¢ä¸­ï¼ˆä¸­é•·æœŸãƒ•ã‚©ãƒ­ãƒ¼ï¼‰
--   âš« ã‚¯ãƒ­ãƒ¼ã‚ºï¼ˆçµ‚äº†ï¼‰
SELECT 
  member_name as æ‹…å½“è€…,
  COUNT(DISTINCT candidate_id) as åˆå›žæ•°
FROM stg_member_monthly
WHERE month_text = '2026_01'
  AND member_name = 'ç€§æ¾¤'
  AND assigned_date IS NOT NULL
  AND assigned_date != ''
  -- å‰²ã‚ŠæŒ¯ã‚Šæ—¥ãŒ2026å¹´1æœˆ
  AND (
    assigned_date LIKE '2026/1/%' OR
    assigned_date LIKE '2026/01/%' OR
    TO_DATE(assigned_date, 'YYYY/MM/DD') >= '2026-01-01'::DATE
    AND TO_DATE(assigned_date, 'YYYY/MM/DD') < '2026-02-01'::DATE
  )
  -- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒåˆå›žé€£çµ¡æ¸ˆã¿ä»¥é™
  AND status IN (
    'ðŸŸ£ ææ¡ˆæ±‚äººé¸å®šä¸­',
    'ðŸŸ¤ æ±‚äººææ¡ˆæ¸ˆï¼ˆè¿”ä¿¡å¾…ã¡ï¼‰',
    'ðŸŸ¢ æ›¸é¡žé¸è€ƒä¸­',
    'ðŸŸ¢ é¢æŽ¥æ—¥ç¨‹èª¿æ•´ä¸­',
    'ðŸŸ¢ é¢æŽ¥ç¢ºå®šæ¸ˆ',
    'ðŸŸ  é¢æŽ¥å®Ÿæ–½æ¸ˆï¼ˆçµæžœå¾…ã¡ï¼‰',
    'ðŸŸ£ å†…å®šç²å¾—ï¼ˆæ‰¿è«¾ç¢ºèªä¸­ï¼‰',
    'ðŸŸ¢ å†…å®šæ‰¿è«¾ï¼ˆæˆç´„ï¼‰',
    'ðŸ”´ å†…å®šè¾žé€€',
    'âšª éŸ³ä¿¡ä¸é€š',
    'âšª è¿½å®¢ä¸­ï¼ˆä¸­é•·æœŸãƒ•ã‚©ãƒ­ãƒ¼ï¼‰',
    'âš« ã‚¯ãƒ­ãƒ¼ã‚ºï¼ˆçµ‚äº†ï¼‰'
  )
GROUP BY member_name;

-- 3. é¢æŽ¥ï¼ˆé¢æŽ¥è¨­å®šæ•°ï¼‰
-- æ¡ä»¶: æ‹…å½“è€…ãŒç€§æ¾¤ã‹ã¤ã€é¢æŽ¥è¨­å®šã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒå½“æœˆã‹ã¤ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒä»¥ä¸‹ã®ã„ãšã‚Œã‹
-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒªã‚¹ãƒˆ:
--   é¢æŽ¥ç¢ºå®šæ¸ˆ
--   é¢æŽ¥å®Ÿæ–½æ¸ˆï¼ˆçµæžœå¾…ã¡ï¼‰
--   å†…å®šç²å¾—ï¼ˆæ‰¿è«¾ç¢ºèªä¸­ï¼‰
--   å†…å®šæ‰¿è«¾ï¼ˆæˆç´„ï¼‰
--   å†…å®šè¾žé€€
-- 
-- æ³¨æ„: ã€Œé¢æŽ¥è¨­å®šã‚¿ã‚¤ãƒŸãƒ³ã‚°ã€ã¯é¢æŽ¥ãƒ•ãƒ©ã‚°ãŒTRUEã«ãªã£ãŸæ—¥ä»˜ã‚’æŒ‡ã™
-- æœˆæ¬¡ãƒžãƒ¼ã‚¸ã‚·ãƒ¼ãƒˆã§ã¯ã€é¢æŽ¥ãƒ•ãƒ©ã‚°=TRUEã®è¡Œã®å‰²ã‚ŠæŒ¯ã‚Šæ—¥ã¾ãŸã¯month_textã‚’å‚ç…§
SELECT 
  member_name as æ‹…å½“è€…,
  COUNT(DISTINCT candidate_id) as é¢æŽ¥æ•°
FROM stg_member_monthly
WHERE month_text = '2026_01'
  AND member_name = 'ç€§æ¾¤'
  -- é¢æŽ¥ãƒ•ãƒ©ã‚°ãŒTRUEï¼ˆé¢æŽ¥è¨­å®šæ¸ˆã¿ï¼‰
  AND UPPER(interview_flag) = 'TRUE'
  -- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒé¢æŽ¥ç¢ºå®šä»¥é™
  AND status IN (
    'ðŸŸ¢ é¢æŽ¥ç¢ºå®šæ¸ˆ',
    'ðŸŸ  é¢æŽ¥å®Ÿæ–½æ¸ˆï¼ˆçµæžœå¾…ã¡ï¼‰',
    'ðŸŸ£ å†…å®šç²å¾—ï¼ˆæ‰¿è«¾ç¢ºèªä¸­ï¼‰',
    'ðŸŸ¢ å†…å®šæ‰¿è«¾ï¼ˆæˆç´„ï¼‰',
    'ðŸ”´ å†…å®šè¾žé€€'
  )
GROUP BY member_name;

-- 4. æˆç´„ï¼ˆæˆç´„æ•°ï¼‰
-- æ¡ä»¶: æ‹…å½“è€…ãŒç€§æ¾¤ã‹ã¤ã€é¢æŽ¥è¨­å®šã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒå½“æœˆã‹ã¤ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒã€Œå†…å®šæ‰¿è«¾ï¼ˆæˆç´„ï¼‰ã€
SELECT 
  member_name as æ‹…å½“è€…,
  COUNT(DISTINCT candidate_id) as æˆç´„æ•°
FROM stg_member_monthly
WHERE month_text = '2026_01'
  AND member_name = 'ç€§æ¾¤'
  -- é¢æŽ¥ãƒ•ãƒ©ã‚°ãŒTRUEï¼ˆé¢æŽ¥è¨­å®šæ¸ˆã¿ï¼‰
  AND UPPER(interview_flag) = 'TRUE'
  -- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒã€Œå†…å®šæ‰¿è«¾ï¼ˆæˆç´„ï¼‰ã€
  AND status = 'ðŸŸ¢ å†…å®šæ‰¿è«¾ï¼ˆæˆç´„ï¼‰'
GROUP BY member_name;

-- ========================================
-- å…¨æ‹…å½“è€…ã®1æœˆåˆ†ã®é›†è¨ˆï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰
-- ========================================
WITH monthly_data AS (
  SELECT 
    member_name,
    candidate_id,
    assigned_date,
    status,
    interview_flag,
    month_text
  FROM stg_member_monthly
  WHERE month_text = '2026_01'
    AND assigned_date IS NOT NULL
    AND assigned_date != ''
)
SELECT 
  member_name as æ‹…å½“è€…,
  -- æ‹…å½“: å‰²ã‚ŠæŒ¯ã‚Šæ—¥ãŒå½“æœˆã®æ•°
  COUNT(DISTINCT CASE 
    WHEN (
      assigned_date LIKE '2026/1/%' OR
      assigned_date LIKE '2026/01/%' OR
      TO_DATE(assigned_date, 'YYYY/MM/DD') >= '2026-01-01'::DATE
      AND TO_DATE(assigned_date, 'YYYY/MM/DD') < '2026-02-01'::DATE
    ) THEN candidate_id
  END) as æ‹…å½“,
  -- åˆå›ž: å‰²ã‚ŠæŒ¯ã‚Šæ—¥ãŒå½“æœˆã‹ã¤ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒåˆå›žé€£çµ¡æ¸ˆã¿ä»¥é™
  COUNT(DISTINCT CASE 
    WHEN (
      assigned_date LIKE '2026/1/%' OR
      assigned_date LIKE '2026/01/%' OR
      TO_DATE(assigned_date, 'YYYY/MM/DD') >= '2026-01-01'::DATE
      AND TO_DATE(assigned_date, 'YYYY/MM/DD') < '2026-02-01'::DATE
    )
    AND status IN (
      'ðŸŸ£ ææ¡ˆæ±‚äººé¸å®šä¸­',
      'ðŸŸ¤ æ±‚äººææ¡ˆæ¸ˆï¼ˆè¿”ä¿¡å¾…ã¡ï¼‰',
      'ðŸŸ¢ æ›¸é¡žé¸è€ƒä¸­',
      'ðŸŸ¢ é¢æŽ¥æ—¥ç¨‹èª¿æ•´ä¸­',
      'ðŸŸ¢ é¢æŽ¥ç¢ºå®šæ¸ˆ',
      'ðŸŸ  é¢æŽ¥å®Ÿæ–½æ¸ˆï¼ˆçµæžœå¾…ã¡ï¼‰',
      'ðŸŸ£ å†…å®šç²å¾—ï¼ˆæ‰¿è«¾ç¢ºèªä¸­ï¼‰',
      'ðŸŸ¢ å†…å®šæ‰¿è«¾ï¼ˆæˆç´„ï¼‰',
      'ðŸ”´ å†…å®šè¾žé€€',
      'âšª éŸ³ä¿¡ä¸é€š',
      'âšª è¿½å®¢ä¸­ï¼ˆä¸­é•·æœŸãƒ•ã‚©ãƒ­ãƒ¼ï¼‰',
      'âš« ã‚¯ãƒ­ãƒ¼ã‚ºï¼ˆçµ‚äº†ï¼‰'
    ) THEN candidate_id
  END) as åˆå›ž,
  -- é¢æŽ¥: é¢æŽ¥ãƒ•ãƒ©ã‚°=TRUEã‹ã¤ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒé¢æŽ¥ç¢ºå®šä»¥é™
  COUNT(DISTINCT CASE 
    WHEN UPPER(interview_flag) = 'TRUE'
    AND status IN (
      'ðŸŸ¢ é¢æŽ¥ç¢ºå®šæ¸ˆ',
      'ðŸŸ  é¢æŽ¥å®Ÿæ–½æ¸ˆï¼ˆçµæžœå¾…ã¡ï¼‰',
      'ðŸŸ£ å†…å®šç²å¾—ï¼ˆæ‰¿è«¾ç¢ºèªä¸­ï¼‰',
      'ðŸŸ¢ å†…å®šæ‰¿è«¾ï¼ˆæˆç´„ï¼‰',
      'ðŸ”´ å†…å®šè¾žé€€'
    ) THEN candidate_id
  END) as é¢æŽ¥,
  -- æˆç´„: é¢æŽ¥ãƒ•ãƒ©ã‚°=TRUEã‹ã¤ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒã€Œå†…å®šæ‰¿è«¾ï¼ˆæˆç´„ï¼‰ã€
  COUNT(DISTINCT CASE 
    WHEN UPPER(interview_flag) = 'TRUE'
    AND status = 'ðŸŸ¢ å†…å®šæ‰¿è«¾ï¼ˆæˆç´„ï¼‰' THEN candidate_id
  END) as æˆç´„
FROM monthly_data
GROUP BY member_name
ORDER BY æ‹…å½“ DESC;
