# 1月分データ追加手順（詳細版）

## 📋 事前準備

- Supabase Dashboardにアクセスできること
- Python 3がインストールされていること（CSV抽出用）

## 🔧 ステップ0: 1月分のCSVファイルを作成（初回のみ）

元のCSVファイルには10月〜1月の全データが含まれているため、1月分だけを抽出したCSVファイルを作成します。

### 方法1: Pythonスクリプトを使用（推奨）

1. ターミナルを開く
2. 以下のコマンドを実行：

```bash
cd "/Users/a2025-057/Desktop/ishii/12_SaaS開発ドキュメント/hoiku-crm/supabase"
python3 extract_january_csv.py
```

3. 成功すると、`stg_member_monthly_2026_01.csv` が作成されます（327件のデータ）

### 方法2: 手動で抽出

1. 元のCSVファイルをExcelやGoogleスプレッドシートで開く
2. 「年月」列でフィルタをかけて `2026_01` のみを表示
3. フィルタ後のデータをコピーして新しいCSVファイルに保存
4. ファイル名を `stg_member_monthly_2026_01.csv` とする

---

## 🚀 手順

### ステップ1: テーブルの確認・作成（初回のみ）

もし`stg_member_monthly`テーブルが存在しない場合は、先に作成します。

1. Supabase Dashboard → **SQL Editor** を開く
2. 以下のSQLを実行：

```sql
CREATE TABLE IF NOT EXISTS stg_member_monthly (
  month_text TEXT,
  member_name TEXT,
  candidate_id TEXT,
  assigned_date TEXT,
  candidate_name TEXT,
  lead_source TEXT,
  category TEXT,
  status TEXT,
  expected_amount TEXT,
  prob_current TEXT,
  prob_next TEXT,
  contract_amount TEXT,
  interview_flag TEXT
);
```

---

### ステップ2: CSVデータをSupabaseにインポート

#### 2-1. テーブルを開く

1. Supabase Dashboardにログイン
2. 左メニューから **Table Editor** をクリック
3. `stg_member_monthly` テーブルを選択

#### 2-2. CSVをインポート

1. テーブル画面の上部にある **Import CSV** ボタンをクリック
2. **Select a file** をクリック
3. 以下のファイルを選択：
   ```
   hoiku-crm/supabase/stg_member_monthly_2026_01.csv
   ```
   （ステップ0で作成した1月分のみのCSVファイル）
4. **Next** をクリック

#### 2-3. カラムマッピングの確認

Supabaseが自動でマッピングを提案しますが、以下のように確認してください：

| CSVのカラム名 | テーブルのカラム名 |
|------------|----------------|
| 年月 | month_text |
| メンバー名 | member_name |
| ID | candidate_id |
| 割り振り日 | assigned_date |
| 求職者名 | candidate_name |
| リード獲得先 | lead_source |
| カテゴリ | category |
| ステータス | status |
| ヨミ金額 | expected_amount |
| ヨミ確度(当月) | prob_current |
| ヨミ確度(翌月) | prob_next |
| 成約金額 | contract_amount |
| 面接フラグ | interview_flag |

**注意**: 最後の2つの空カラム（`,,`）は無視してOKです。

5. **Import** をクリック
6. インポートが完了するまで待つ（数秒〜数分）

#### 2-4. インポート結果の確認（オプション）

```sql
-- 1月分のデータが正しくインポートされたか確認
SELECT 
  month_text,
  COUNT(*) as count
FROM stg_member_monthly
WHERE month_text = '2026_01'
GROUP BY month_text;
```

---

### ステップ3: projectsテーブルにデータを反映

1. Supabase Dashboard → **SQL Editor** を開く
2. **New query** をクリック
3. `import_january_data.sql` の内容をコピー＆ペースト
   - または、ファイルを直接開いて全選択（Cmd+A / Ctrl+A）→ コピー（Cmd+C / Ctrl+C）
4. **Run** ボタンをクリック（または Cmd+Enter / Ctrl+Enter）
5. 実行結果を確認

#### 実行結果の見方

SQLの最後に確認クエリが含まれているので、以下のような結果が表示されます：

```
1月分データ追加結果 | total_projects | with_yomi | yomi_a | yomi_b | yomi_c
---------------------|----------------|-----------|--------|--------|--------
1月分データ追加結果  | 327           | 45        | 5      | 12     | 28
```

- `total_projects`: 追加されたプロジェクトの総数
- `with_yomi`: ヨミ金額が設定されている件数
- `yomi_a`, `yomi_b`, `yomi_c`: 確度別の件数

---

### ステップ4: 最終確認

以下のクエリで月別のデータ件数を確認できます：

```sql
-- 月別データ件数確認
SELECT 
  month_text,
  COUNT(*) as project_count
FROM projects
WHERE month_text IS NOT NULL
GROUP BY month_text
ORDER BY month_text DESC;
```

期待される結果例：
```
month_text | project_count
-----------|---------------
2026_01    | 327
2025_12    | 450
2025_11    | 420
2025_10    | 380
```

---

## ⚠️ よくあるエラーと対処法

### エラー1: "relation stg_member_monthly does not exist"

**原因**: テーブルが作成されていない

**対処法**: ステップ1を実行してテーブルを作成してください

---

### エラー2: "duplicate key value violates unique constraint"

**原因**: 既に同じデータが存在している

**対処法**: 
- SQLには`NOT EXISTS`条件があるので、通常は重複しません
- もしエラーが出る場合は、既にデータが追加済みの可能性があります
- 以下のクエリで確認：

```sql
SELECT COUNT(*) 
FROM projects 
WHERE month_text = '2026_01';
```

---

### エラー3: データが追加されない（エラーは出ないが件数が0）

**原因**: `candidates`テーブルに対応する`candidate_id`が存在しない

**対処法**: 
1. まず、CSVに含まれる`candidate_id`を確認：

```sql
SELECT DISTINCT candidate_id 
FROM stg_member_monthly 
WHERE month_text = '2026_01'
LIMIT 10;
```

2. そのIDが`candidates`テーブルに存在するか確認：

```sql
SELECT id 
FROM candidates 
WHERE id IN (
  SELECT DISTINCT candidate_id 
  FROM stg_member_monthly 
  WHERE month_text = '2026_01'
);
```

3. 存在しないIDがある場合は、先に`candidates`テーブルにデータを追加する必要があります

---

### エラー4: CSVインポート時にカラムマッピングがうまくいかない

**原因**: CSVのヘッダー行が正しく認識されていない

**対処法**:
1. CSVファイルをテキストエディタで開いて、1行目が正しいヘッダーか確認
2. BOM（Byte Order Mark）が含まれている場合は削除
3. 文字コードをUTF-8に統一

---

## ✅ 完了チェックリスト

- [ ] `stg_member_monthly`テーブルが存在する
- [ ] CSVデータが正しくインポートされた（ステップ2-4の確認クエリで件数が表示される）
- [ ] SQLを実行してエラーが出ない
- [ ] 確認クエリで1月分のデータが表示される
- [ ] 月別データ件数確認で`2026_01`が表示される

---

## 📞 困ったときは

- SQLのエラーメッセージをコピーして確認
- Supabase Dashboardの **Logs** タブで詳細なエラーを確認
- `stg_member_monthly`テーブルにデータが正しく入っているか確認

---

## 💡 補足情報

- **重複防止**: 同じ`candidate_id`と`month_text`の組み合わせは自動的にスキップされます
- **client_name**: 月次マージシートには園名・法人名の情報がないため、すべて`'未設定'`になります
- **ヨミ金額**: カンマ区切りの文字列（例: `"300,000"`）は自動的に数値に変換されます
