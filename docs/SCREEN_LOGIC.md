# 画面仕様とビジネスロジック

> **重要**: このドキュメントは各画面の「なぜ」と「何をすべきか」を明確に記載しています。AIエージェントが機能を追加・修正する際の判断基準として使用してください。

## 1. ダッシュボード (`/`)

### 画面の目的

ダッシュボードは、**経営層や管理者が全体の進捗を一目で把握する**ための画面です。予算達成状況、KPI、プロセス別の進捗を可視化します。

### ユーザーの意図

- 今月の予算達成状況を確認したい
- 目標に対する実績の乖離を把握したい
- 全体のプロセス進捗を確認したい
- 登録者数と流入経路の統計を確認したい

### 主要機能とその理由

#### 1. 期間選択機能

**なぜ必要か**: 当月だけでなく、前月や任意の期間のデータを確認したい場合があるため

**データの扱い方**:
- 期間タイプ（`current_month`, `previous_month`, `custom`）を`useState`で管理
- カスタム期間の開始日・終了日も`useState`で管理
- **重要**: 期間が変更されると、すべてのデータ（予算、売上、KPI、統計）を選択期間でフィルタリングする
- **必須実装**: 予算の設定、売上と日時の紐付け（`contracts.contracted_at`）が必須

**UIの動作**:
- 「当月」「前月」「指定期間」ボタンをクリックすると、期間タイプが切り替わる
- 「指定期間」を選択すると、Popoverが開き、開始日・終了日を入力できる
- 「今週」「月初〜今日」ボタンでクイック選択可能

**期間フィルタリングの対象データ**:
- 売上: `contracts.contracted_at`が期間内
- 登録者数: `candidates.registered_at`が期間内
- 面接設定数: `interviews.start_at`が期間内
- 成約数: `contracts.contracted_at`が期間内
- Aヨミ/Bヨミ: `projects`の期間判定（要定義）

#### 2. トップライン情報カード

**なぜ必要か**: 最重要な数値を一目で確認するため

**データの扱い方**:
- `mockMemberStats`から`totalSales`, `totalYomiA`, `totalYomiB`を集計
- `totalBudget`は定数として`mock-data.ts`から取得
- 不足金額は計算: `totalBudget - totalSales - totalYomiA - totalYomiB`

**表示内容**:
- 残り営業日: 固定値（現在は2日）
- 予算達成状況: 予算、売上、Aヨミ、Bヨミを表示
- 不足金額: 計算結果を表示

#### 3. 目標数値の前提条件カード

**なぜ必要か**: KPI計算の基準となる目標値と実績を比較するため

**データの扱い方**:
- 目標値: `kpiAssumptions`から取得（`mock-data.ts`）
- 実績値: 選択期間に応じて計算（**期間フィルタリング必須**）
  - **登録→初回率**: `(初回済み人数 / 選択期間内の登録者数) * 100`
    - 分母: 選択期間内に`candidates.registered_at`が含まれる求職者数
    - 分子: 上記登録者の中で、ステータスが`first_contact_done`以降の求職者数
  - **初回→面接率**: `(選択期間内に面接を設定した人数 / 初回済み人数) * 100`
    - 分母: ステータスが`first_contact_done`以降の求職者数（期間に関係なく）
    - 分子: 選択期間内に`interviews.start_at`が設定された面接の、ユニークな求職者数
  - **面接→成約率**: `(選択期間内の成約人数 / 選択期間内に面接を設定した人数) * 100`
    - 分母: 選択期間内に`interviews.start_at`が設定された面接の、ユニークな求職者数
    - 分子: 選択期間内に`contracts.contracted_at`が含まれる成約数
  - **成約単価**: `選択期間内の売上合計 / 選択期間内の成約人数`
    - 分子: 選択期間内の`contracts.revenue_including_tax`の合計
    - 分母: 選択期間内の`contracts.contracted_at`が含まれる成約数

**UIの動作**:
- 目標と実績を同じサイズ（`text-3xl font-bold`）で表示
- 実績が目標以上なら緑色、未達ならオレンジ色で表示

**重要**: すべてのKPI計算は選択期間内のデータを使用する（詳細は`DASHBOARD_REQUIREMENTS.md`を参照）

#### 4. 全体プロセス進捗カード

**なぜ必要か**: 全社の案件がどのフェーズにあるかを把握するため

**データの扱い方**:
- `mockCandidates`をステータスごとに集計
- `processStatusLabels`でステータスをプロセス名に変換
- 件数と割合を表示

#### 5. 登録者数サマリーカード

**なぜ必要か**: 登録者数と流入経路の統計を把握するため

**データの扱い方**:
- `mockCandidates`から今月の応募数を集計（`registered_at`が今月のもの）
- 流入経路ごとに新規人数を集計（LINEを除く）
- 全体の登録者数を集計
- 流入経路割合を計算（LINEを除く）

**表示内容**:
- 今月の応募数: 今月登録された求職者数
- 全体の人数: 全登録者数
- 流入経路ごとの新規人数: 各流入経路の今月の新規登録数と全体の人数（LINEを除く）
- 流入経路割合: 各流入経路の全体に占める割合をプログレスバーで表示（LINEを除く）

### 判断が必要な場面

- 期間選択でデータをフィルタリングするかどうか: **必ずフィルタリングする**（選択期間内のデータのみを表示）
- 実績の計算方法: **選択期間内のデータから計算**（保存された値を使用しない）
- 予算の取得方法: **選択期間に応じた予算を取得**（月次予算の設定・管理が必要）

### 関連ドキュメント

詳細な実装要件は`DASHBOARD_REQUIREMENTS.md`を参照してください。

---

## 2. 求職者管理 (`/candidates`)

### 画面の目的

求職者管理画面は、**すべての求職者を一覧表示し、検索・フィルタリング・ステータス変更を行う**ための画面です。また、**コンサルタントが「今日誰に対応すべきか」を優先度順に確認する**タスク機能も統合されています。

### ユーザーの意図

- 求職者を検索したい
- ステータスや担当者でフィルタリングしたい
- ステータスを変更したい
- 担当者を変更したい
- 求職者詳細を確認したい
- 今日対応すべき求職者を優先度順に確認したい
- 優先度別のタスク数を把握したい

### 主要機能とその理由

#### 1. タブ切り替え（全体/アクティブ/今日のタスク）

**なぜ必要か**: 全求職者、進行中の求職者、今日対応すべきタスクを切り替えて表示するため

**データの扱い方**:
- `activeTab` stateで管理
- 「全体」: すべての求職者を表示
- 「アクティブ」: アクティブなステータスの求職者のみ表示
- 「今日のタスク」: アクティブなステータスの求職者を優先度順でソート

#### 2. 優先度別サマリーカード（今日のタスクタブ）

**なぜ必要か**: 優先度別のタスク数を一目で確認するため

**データの扱い方**:
- `mockCandidates`からアクティブなステータスの求職者のみを抽出
- `getApproachPriority`関数で優先度を取得（登録経路に基づく自動判定）
- 優先度別にカウント

**UIの動作**:
- カードをクリックすると、その優先度でフィルタリング
- 再度クリックするとフィルター解除

#### 3. 検索・フィルター機能

**なぜ必要か**: 大量の求職者の中から目的の求職者を素早く見つけるため

**データの扱い方**:
- 検索クエリ: `searchQuery` stateで管理
- 氏名、ID、電話番号で検索（部分一致）
- ステータスフィルター: `statusFilter` stateで管理
- 担当者フィルター: `consultantFilter` stateで管理（メンバーアバターボタン形式）

#### 4. 担当者フィルター

**なぜ必要か**: メンバーごとの担当求職者を素早く確認するため

**UIの動作**:
- 「すべて」ボタンと各メンバーのアバターボタンを横並びで表示
- クリックで担当者フィルターを切り替え
- 選択中のメンバーはハイライト表示

#### 3. ステータス変更

**なぜ必要か**: 求職者の進捗状況を更新するため

**データの扱い方**:
- `candidateStatuses` stateで変更を管理（画面内でのみ有効）
- ステータスが`closed_won`になったら、自動的に`contracts`にレコードを作成
- **重要**: 変更は`candidateStatuses` stateに保存するが、データソース（`mock-data.ts`）には反映しない（プロトタイプのため）

**UIの動作**:
- ステータス列のBadgeをクリックするとプルダウンが開く
- ステータスを選択すると、即座に表示が更新される

#### 4. 担当者変更

**なぜ必要か**: 求職者の担当者を変更するため

**データの扱い方**:
- `candidateConsultants` stateで変更を管理
- 変更は画面内でのみ有効

**UIの動作**:
- 担当者列をクリックするとプルダウンが開く
- 担当者を選択すると、即座に表示が更新される

#### 5. ランクと優先度の両方表示

**なぜ必要か**: 求職者の重要度（ランク）と今日のアプローチ優先度を両方確認するため

**データの扱い方**:
- ランク: `mockCandidateRanks`から取得（求職者の総合的な重要度）
- 優先度: `mockApproachPriorities`または登録経路から自動判定（今日のアプローチ優先度）

**UIの動作**:
- テーブルに「ランク」と「優先度」の両方の列を表示
- 優先度は変更可能（プルダウンで変更）

### 判断が必要な場面

- ステータス変更時の自動処理: **`closed_won`になったら必ず`contracts`にレコードを作成**
- データの保存: **プロトタイプではstateで管理のみ**（本番環境ではSupabaseに保存）
- 優先度の自動判定ルール: **登録経路（`source_id`）に基づいて自動判定**（詳細は`BUSINESS_RULES.md`参照）
- 優先度の変更: **`priorities` stateで管理**（画面内でのみ有効、データソースには保存しない）

---

## 3. 求職者詳細 (`/candidates/[id]`)

### 画面の目的

求職者詳細画面は、**個別の求職者の詳細情報を表示・編集する**ための画面です。

### ユーザーの意図

- 求職者の基本情報を確認したい
- 選考状況を確認したい
- 成約情報を確認・編集したい
- タイムラインを確認したい
- メモを追加・編集したい

### 主要機能とその理由

#### 1. 基本情報表示

**なぜ必要か**: 求職者の基本情報を確認するため

**データの扱い方**:
- `mockCandidates`から該当IDの求職者を取得
- 担当者情報は`mockUsers`から取得

#### 2. 選考状況タブ

**なぜ必要か**: 求職者が応募している園（案件）の進捗を確認するため

**データの扱い方**:
- `mockProjects`から該当求職者の案件を取得
- 各案件に関連する`mockInterviews`を取得

#### 3. 成約情報タブ

**なぜ必要か**: 成約した求職者の売上・入金情報を管理するため

**データの扱い方**:
- `mockContracts`から該当求職者の成約情報を取得
- 成約情報は編集可能（ダイアログで編集）

**UIの動作**:
- 「編集」ボタンをクリックするとダイアログが開く
- 編集内容を保存すると、`contractForm` stateが更新される

#### 4. タイムラインタブ

**なぜ必要か**: 求職者への対応履歴を時系列で確認するため

**データの扱い方**:
- `localStorage`からタイムラインイベントを取得（`timelineEvents`キー）
- `mockMemos`からメモを取得
- 両方を統合して時系列で表示

**UIの動作**:
- タイムラインイベントは面接一覧ページで作成されたものが表示される
- メモは求職者詳細ページで追加されたものが表示される

#### 5. メモタブ

**なぜ必要か**: 求職者への対応内容を記録するため

**データの扱い方**:
- `mockMemos`から該当求職者のメモを取得
- メモの追加・編集はダイアログで行う

### 判断が必要な場面

- タイムラインイベントの取得: **`localStorage`から取得**（面接一覧ページで作成されたイベント）
- 戻るボタンの動作: **URLパラメータ（`from`）に応じて遷移先を変更**（メンバーページから来た場合はメンバーページに戻る）

---

## 4. 成約管理 (`/contracts`)

### 画面の目的

成約管理画面は、**成約した求職者の売上・入金状況を管理する**ための画面です。

### ユーザーの意図

- 月別の成約件数と売上を確認したい
- 担当者別の成約状況を確認したい
- 入金状況を確認したい
- 成約情報を編集したい

### 主要機能とその理由

#### 1. 月選択機能

**なぜ必要か**: 月別のデータを確認するため

**データの扱い方**:
- `selectedMonth` stateで管理（形式: `YYYY-MM`）
- `mockContracts`から該当月のデータをフィルタリング

#### 2. サマリーカード

**なぜ必要か**: 月別の成約件数、売上、入金状況を一目で確認するため

**データの扱い方**:
- `filteredContracts`から集計
- 成約件数、売上（税抜・税込）、入金済み件数、入金待ち件数を計算

#### 3. 成約一覧テーブル

**なぜ必要か**: 個別の成約情報を確認・編集するため

**データの扱い方**:
- `mockContracts`から該当月のデータを表示
- 担当者情報は`contractConsultants`から取得

**UIの動作**:
- 編集ボタンをクリックすると、インライン編集モードになる
- 保存ボタンをクリックすると、`contracts` stateが更新される

#### 4. キャンセル対応機能

**なぜ必要か**: 成約後に入社を辞退した場合の返金情報を管理するため

**データの扱い方**:
- `cancellingContractId` stateで編集中の成約IDを管理
- `cancelFormData` stateでキャンセル情報（返金あり/なし、返金日、返金額、備考）を管理
- 保存時に`contracts` stateを更新し、`is_cancelled`を`true`に設定

**UIの動作**:
- 「キャンセル対応」ボタンをクリックするとダイアログが開く
- 返金あり/なしのチェックボックスを変更すると、返金日・返金額フィールドの表示/非表示が切り替わる
- 返金ありを選択した場合、返金日と返金額は必須入力
- 保存ボタンをクリックすると、`contracts` stateが更新され、ステータス列に「キャンセル済み」バッジが表示される

**ステータス表示**:
- キャンセル済みの成約は、ステータス列に「キャンセル済み」バッジを表示（「入金済み」「入金待ち」の代わり）

### 判断が必要な場面

- 成約情報の編集: **`contracts` stateで管理**（プロトタイプではデータソースには反映しない）
- 担当者の取得: **`contractConsultants`マッピングから取得**（`mockCandidates`にない成約者も含む）
- キャンセル情報の保存: **`is_cancelled`を`true`に設定し、返金情報も同時に保存**（データの整合性を保つため）

---

## 5. メンバー (`/members`)

### 画面の目的

**注意**: メンバー画面はサイドバーナビゲーションから削除されました。通常の利用では、求職者管理画面 (`/candidates`) の担当者フィルタを使用してメンバー別の求職者を確認してください。メンバー画面は直接URLでアクセス可能ですが、非推奨です。

メンバー画面は、**担当者別の進捗・ヨミ・担当求職者を管理する**ための画面です（非推奨）。

### ユーザーの意図

- 担当者のKPIを確認したい
- 担当者のヨミ数字を確認したい
- 担当者の担当求職者を確認したい
- 求職者のステータスを変更したい

### 主要機能とその理由

#### 1. メンバーリスト

**なぜ必要か**: 担当者を選択するため

**データの扱い方**:
- `mockUsers`から管理者以外のユーザーを取得
- 各メンバーの担当件数と売上を表示

**UIの動作**:
- メンバーをクリックすると、そのメンバーの詳細が表示される
- URLパラメータ（`selected`）で選択状態を保持

#### 2. KPIカード

**なぜ必要か**: 担当者の売上・面談設定数などのKPIを確認するため

**データの扱い方**:
- `mockMemberStats`から該当ユーザーの統計情報を取得
- 売上予算、成約額、面談設定数、担当件数を表示

#### 3. ヨミ数字カード

**なぜ必要か**: 担当者の当月・翌月のヨミを確認するため

**データの扱い方**:
- `mockMemberStats`からA/B/C/Dヨミを取得
- 当月と翌月を別々のカードで表示

#### 4. 担当求職者一覧テーブル

**なぜ必要か**: 担当者の担当求職者を一覧表示するため

**データの扱い方**:
- `mockCandidates`から該当担当者の求職者を取得
- ステータス、案件、ヨミを表示

**UIの動作**:
- 氏名をクリックすると求職者詳細ページに遷移
- ステータスはプルダウンで変更可能（画面内でのみ有効）

### 判断が必要な場面

- URLパラメータの処理: **`selected`パラメータで選択状態を復元**（ページリロード時も状態を保持）
- メンバーカードの表示/非表示: **メンバーが選択されている場合は非表示**（画面スペースの有効活用）

---

## 6. 面接一覧 (`/interviews`)

### 画面の目的

面接一覧画面は、**すべての面接を一覧表示し、ステータス・担当者を変更する**ための画面です。

### ユーザーの意図

- 面接の予定・実績を確認したい
- 面接のステータスを変更したい
- 面接の担当者を変更したい
- 面接のフィードバックを確認したい

### 主要機能とその理由

#### 1. サマリーカード

**なぜ必要か**: 面接の予定数、完了数、成約数を一目で確認するため

**データの扱い方**:
- `mockInterviews`から集計
- 予定件数、完了件数、今月の成約数を表示

#### 2. フィルター機能

**なぜ必要か**: ステータスや担当者でフィルタリングするため

**データの扱い方**:
- `statusFilter` stateでステータスフィルターを管理
- `consultantFilter` stateで担当者フィルターを管理

#### 3. タブ切り替え（すべて/予定/完了）

**なぜ必要か**: 面接の状態で切り替えて表示するため

**データの扱い方**:
- タブの値に応じて`filteredInterviews`をフィルタリング

#### 4. ステータス変更

**なぜ必要か**: 面接の進捗状況を更新するため

**データの扱い方**:
- `interviewStatuses` stateで変更を管理
- ステータス変更時にタイムラインイベントを作成
- タイムラインイベントは`localStorage`に保存（求職者詳細ページで表示されるため）

**UIの動作**:
- ステータス列のBadgeをクリックするとプルダウンが開く
- ステータスを選択すると、即座に表示が更新され、タイムラインイベントが作成される

#### 5. 担当者変更

**なぜ必要か**: 面接の担当者を変更するため

**データの扱い方**:
- `interviewConsultants` stateで変更を管理
- 担当者変更時に、関連する求職者の担当者も更新（`candidateConsultants` state）
- 担当者変更時にタイムラインイベントを作成
- タイムラインイベントは`localStorage`に保存

**UIの動作**:
- 担当者列をクリックするとプルダウンが開く
- 担当者を選択すると、即座に表示が更新され、タイムラインイベントが作成される

### 判断が必要な場面

- タイムラインイベントの作成: **ステータス変更・担当者変更時に必ず作成**（求職者詳細ページで表示されるため）
- 担当者の連動更新: **面接の担当者を変更したら、関連する求職者の担当者も更新**（データの整合性を保つため）
- タイムラインイベントの保存先: **`localStorage`に保存**（画面間での共有のため）

---

## 共通の判断基準

### データの取得元

- **基本データ**: `mock-data.ts`から取得（`mockCandidates`, `mockProjects`, `mockInterviews`, `mockUsers`, `mockContracts`, `mockMemos`）
- **タイムラインイベント**: `localStorage`から取得（`timelineEvents`キー）
- **設定値**: `mock-data.ts`から取得（`totalBudget`, `kpiAssumptions`, `statusLabels`, `statusColors`など）

### データの保存先

- **プロトタイプ**: `useState`で管理（画面内でのみ有効）
- **本番環境（将来）**: Supabaseに保存
- **タイムラインイベント**: `localStorage`に保存（画面間での共有のため）

### 状態管理の方針

- **フィルター・検索**: `useState`で管理
- **計算結果**: `useMemo`で管理（パフォーマンス最適化）
- **編集状態**: `useState`で管理

### UIの一貫性

- **カラースキーム**: バイオレット/インディゴをプライマリ、グリーン/エメラルドを成功、ローズ/レッドを重要として使用
- **コンポーネント**: Shadcn/UIのコンポーネントを使用（`Card`, `Badge`, `Button`, `Table`, `Select`など）
- **レイアウト**: `AppLayout`コンポーネントで統一（サイドバー、ヘッダーを含む）

## 関連ドキュメント

- [システム目的と設計思想](./SYSTEM_PURPOSE.md) - システムの基本方針
- [データフローと状態管理](./DATA_FLOW.md) - データの流れ
- [ビジネスルール集](./BUSINESS_RULES.md) - システムの動作ルール
