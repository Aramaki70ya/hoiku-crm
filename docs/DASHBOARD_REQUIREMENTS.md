# ダッシュボード機能要件詳細

## 1. 期間選択機能

### 要件
- **「当月」「前月」「指定期間」ボタンで期間を変更できる**
- 選択した期間に応じて、すべてのデータ（予算、売上、KPI、統計）をフィルタリングして表示する

### 必須実装項目

#### 1.1 予算の期間管理
- **予算は期間ごとに設定できる必要がある**
  - 月次予算の設定・管理機能
  - 指定期間の予算計算（日割り計算など）
  - 予算データの保存先：`settings`テーブルまたは専用の`budgets`テーブル

#### 1.2 売上と日時の紐付け
- **売上データは必ず日時（成約日時）と紐付けられている必要がある**
  - `contracts`テーブルの`contracted_at`（成約確定日時）を使用
  - 期間選択時に、`contracted_at`が選択期間内の成約のみを集計
  - 売上の計算：選択期間内の`revenue_including_tax`の合計

#### 1.3 期間フィルタリングの実装
- 選択期間に応じて以下のデータをフィルタリング：
  - **売上**: `contracts.contracted_at`が期間内
  - **Aヨミ/Bヨミ**: `projects`の期間判定（要定義）
  - **登録者数**: `candidates.registered_at`が期間内
  - **面接数**: `interviews.start_at`が期間内
  - **成約数**: `contracts.contracted_at`が期間内

---

## 2. KPIカードの計算ロジック（期間対応）

### 2.1 登録→初回率

**計算式**:
```
登録→初回率 = (初回済み人数 / 当月の登録者数) * 100
```

**データソース**:
- **分母（登録者数）**: 選択期間内に`candidates.registered_at`が含まれる求職者数
- **分子（初回済み人数）**: 上記登録者の中で、ステータスが`first_contact_done`以降の求職者数

**重要**: 分母は**必ず選択期間内の登録者数**を使用する（全期間の登録者数ではない）

---

### 2.2 初回→面接率

**計算式**:
```
初回→面接率 = (その月に面接を設定した人数 / 初回済み人数) * 100
```

**データソース**:
- **分母（初回済み人数）**: ステータスが`first_contact_done`以降の求職者数（期間に関係なく）
- **分子（面接設定人数）**: 選択期間内に`interviews.start_at`が設定された面接の、**ユニークな求職者数**
  - 同じ求職者が期間内に複数回面接を設定していても、1人としてカウント

**重要**: 分子は**選択期間内に面接を設定した人数**を使用する（面接実施済みかどうかは問わない）

---

### 2.3 面接→成約率

**計算式**:
```
面接→成約率 = (選択期間内の成約人数 / 選択期間内に面接を設定した人数) * 100
```

**データソース**:
- **分母（面接設定人数）**: 選択期間内に`interviews.start_at`が設定された面接の、ユニークな求職者数
- **分子（成約人数）**: 選択期間内に`contracts.contracted_at`が含まれる成約数

**重要**: 両方とも**選択期間内の値**を使用する

---

### 2.4 成約単価

**計算式**:
```
成約単価 = 選択期間内の売上合計 / 選択期間内の成約人数
```

**データソース**:
- **分子（売上合計）**: 選択期間内の`contracts.revenue_including_tax`の合計
- **分母（成約人数）**: 選択期間内の`contracts.contracted_at`が含まれる成約数

**重要**: 両方とも**選択期間内の値**を使用する

---

## 3. 予算達成状況カード

### 3.1 予算の取得方法

**実装方針**:
1. **月次予算の設定**: `settings`テーブルに`monthly_budget`として保存
2. **指定期間の予算計算**: 
   - 期間が1ヶ月以内の場合: その月の予算を使用
   - 期間が複数月にまたがる場合: 各月の予算を日割り計算して合計

**データ構造例**:
```typescript
// settingsテーブル
{
  key: 'monthly_budget_2025_01', // 2025年1月の予算
  value: { amount: 29000000 }
}
```

### 3.2 売上の集計

**実装方法**:
```typescript
// 選択期間内の売上を集計
const periodSales = contracts
  .filter(c => {
    if (!c.contracted_at) return false
    const contractedDate = new Date(c.contracted_at)
    return contractedDate >= periodStart && contractedDate <= periodEnd
  })
  .reduce((sum, c) => sum + (c.revenue_including_tax || 0), 0)
```

### 3.3 Aヨミ/Bヨミの集計

**実装方法**:
- `projects`テーブルから、選択期間内に作成・更新された案件のヨミを集計
- 期間判定の基準日: `projects.created_at`または`projects.updated_at`（要確認）

---

## 4. 実装チェックリスト

### 必須実装項目

- [ ] 期間選択機能の実装（当月/前月/指定期間）
- [ ] 予算の期間管理機能（月次予算の設定・取得）
- [ ] 売上データと日時の紐付け確認（`contracts.contracted_at`の必須化）
- [ ] 期間フィルタリングの実装（売上、登録者、面接、成約）
- [ ] KPI計算ロジックの修正（期間対応）
  - [ ] 登録→初回率: 期間内の登録者数を分母に使用
  - [ ] 初回→面接率: 期間内に面接を設定した人数を分子に使用
  - [ ] 面接→成約率: 期間内の値を使用
  - [ ] 成約単価: 期間内の値を使用
- [ ] Aヨミ/Bヨミの期間フィルタリング
- [ ] 残り営業日の計算（選択期間に応じた計算）

### データベース要件

- [ ] `contracts`テーブルに`contracted_at`カラムが必須であることを確認
- [ ] `interviews`テーブルに`start_at`カラムが必須であることを確認
- [ ] `candidates`テーブルに`registered_at`カラムが必須であることを確認
- [ ] 予算管理用のテーブルまたは`settings`テーブルの拡張

---

## 5. ユースケース例

### ユースケース1: 当月のKPI確認

1. ユーザーが「当月」ボタンをクリック
2. システムが当月（例: 2025年1月）の期間を設定
3. 以下のデータを集計：
   - 当月の登録者数: `candidates.registered_at`が2025年1月1日〜31日
   - 当月の面接設定数: `interviews.start_at`が2025年1月1日〜31日
   - 当月の成約数: `contracts.contracted_at`が2025年1月1日〜31日
   - 当月の売上: 上記成約の`revenue_including_tax`の合計
4. KPIを計算して表示

### ユースケース2: 前月との比較

1. ユーザーが「前月」ボタンをクリック
2. システムが前月（例: 2024年12月）の期間を設定
3. 前月のデータを集計して表示
4. ユーザーが「当月」に戻して比較可能

### ユースケース3: 四半期の分析

1. ユーザーが「指定期間」ボタンをクリック
2. 開始日: 2024年10月1日、終了日: 2024年12月31日を入力
3. システムが四半期のデータを集計して表示

---

## 6. 注意事項

1. **期間の境界処理**: 日時の比較時は、時刻部分を考慮する（00:00:00〜23:59:59）
2. **タイムゾーン**: すべての日時はJST（日本標準時）で統一
3. **データの整合性**: 期間フィルタリング時は、関連するすべてのデータ（売上、面接、成約）を同じ期間基準で集計する
4. **パフォーマンス**: 大量データがある場合、期間フィルタリングはデータベースクエリレベルで行う（フロントエンドでのフィルタリングは避ける）
