# ビジネスルール集

> **重要**: このドキュメントはシステムの動作を決定する重要なルールを記載しています。AIエージェントが機能を実装・修正する際は、これらのルールに従う必要があります。

## ステータス遷移ルール

### 求職者ステータス

求職者のステータスは以下の10種類があります：

| ステータスコード | 表示名 | プロセス分類 | 説明 |
|:---|:---|:---|:---|
| `new` | 新規 | リード管理 | 媒体から登録されたばかり |
| `contacting` | 連絡中 | リード管理 | 初回連絡を試みている |
| `first_contact_done` | 初回済み | 面談フェーズ | 初回連絡が完了 |
| `proposing` | 提案中 | 提案フェーズ | 求人を提案している |
| `interviewing` | 面接中 | 面接フェーズ | 面接が予定されている、または実施中 |
| `offer` | 内定 | 内定確認中 | 内定が出ている |
| `closed_won` | 成約 | 内定承諾 | 内定を承諾し、成約が確定 |
| `closed_lost` | NG | フォロー・ロスト | 内定を辞退、または不採用 |
| `pending` | 追客中 | フォロー・ロスト | 一時的に保留中 |
| `on_hold` | 意向回収 | フォロー・ロスト | 意向を確認中 |

### ステータス遷移の制約

**原則**: どのステータスからどのステータスにでも遷移可能（柔軟性を重視）

**ただし、以下の自動処理が発生**:
- `closed_won`に遷移した場合: 自動的に`contracts`テーブルにレコードを作成
  - 既存のレコードがある場合は作成しない（重複防止）
  - 実装ファイル: `src/app/candidates/page.tsx` (227-250行目)

### 面接ステータス

面接のステータスは以下の4種類があります：

| ステータスコード | 表示名 | 説明 |
|:---|:---|:---|
| `scheduled` | 予定 | 面接が予定されている |
| `completed` | 完了 | 面接が完了した |
| `cancelled` | キャンセル | 面接がキャンセルされた |
| `rescheduling` | リスケ中 | 面接日程の調整中 |

**ステータス遷移**: どのステータスからどのステータスにでも遷移可能

## 担当者変更時のルール

### 面接一覧での担当者変更

**ルール**: 面接一覧で担当者を変更した場合、関連する求職者の担当者も自動的に更新する

**実装詳細**:
1. `interviewConsultants` stateを更新（面接の担当者）
2. `candidateConsultants` stateも更新（関連する求職者の担当者）
3. タイムラインイベントを作成（`consultant_change`タイプ）
4. タイムラインイベントを`localStorage`に保存

**実装ファイル**: `src/app/interviews/page.tsx` (305-340行目)

**判断基準**: 
- 面接の担当者を変更したら、必ず求職者の担当者も更新する
- データの整合性を保つため、このルールは必須

### 求職者管理での担当者変更

**ルール**: 求職者管理画面で担当者を変更した場合、その求職者のみ更新する

**実装詳細**:
- `candidateConsultants` stateを更新
- 関連する面接の担当者は更新しない（面接一覧で個別に変更可能）

## タイムライン記録のルール

### 記録するイベント

以下のイベントをタイムラインに記録します：

1. **面接ステータス変更** (`interview_status_change`)
   - タイトル: `面接ステータス変更`
   - 説明: `{求職者名} - {面接先名}: {旧ステータス} → {新ステータス}`
   - 作成タイミング: 面接一覧ページでステータスを変更した時

2. **担当者変更** (`consultant_change`)
   - タイトル: `担当者変更`
   - 説明: `{旧担当者名} → {新担当者名}`
   - 作成タイミング: 面接一覧ページで担当者を変更した時

### 保存先と取得方法

**保存先**: `localStorage`（`timelineEvents`キー）

**保存形式**:
```typescript
{
  id: string                    // 一意のID（`tl-${Date.now()}-${interview.id}`形式）
  candidate_id: string          // 求職者ID
  event_type: string            // イベントタイプ
  title: string                 // イベントタイトル
  description: string           // イベント説明
  created_at: string            // 作成日時（ISO形式）
}
```

**取得方法**: 求職者詳細ページのタイムラインタブで、該当求職者のイベントのみを表示

**実装ファイル**:
- 作成: `src/app/interviews/page.tsx`
- 表示: `src/app/candidates/[id]/page.tsx` (152-161行目)

## 成約時の自動処理

### ルール

求職者のステータスが`closed_won`（成約）になった場合、自動的に`contracts`テーブルにレコードを作成する。

### 処理内容

1. **条件**: ステータスが`closed_won`に変更された時
2. **チェック**: 既存の成約レコードがあるか確認
3. **作成**: 既存レコードがない場合のみ、新しいレコードを作成
4. **初期値**: 
   - `accepted_date`: 現在の日付
   - `revenue_excluding_tax`: 0
   - `revenue_including_tax`: 0
   - その他のフィールド: `null`または空文字

### 実装ファイル

`src/app/candidates/page.tsx` (227-250行目)

### 判断基準

- **必ず実行**: ステータスが`closed_won`になったら、必ずこの処理を実行する
- **重複防止**: 既存レコードがある場合は作成しない
- **初期値**: 売上金額は0で初期化し、後で編集可能にする

## 優先度の自動判定ルール

### ルール

求職者の優先度（S/A/B/C）は、登録経路（`source_id`）に基づいて自動判定されます。

### 判定マッピング

| 媒体ID | 媒体名 | 優先度 | 理由 |
|:---|:---|:---|:---|
| `1` | LINE | S | 個人経由の紹介、反応が早い |
| `8` | 個人掘起こし | S | 紹介経由、確度が高い |
| `2` | バイトル | A | 主要求人サイト、反応が良い |
| `3` | 求人版 | A | 自社メディア、反応が良い |
| `6` | ジョブカン（SGL） | A | 主要求人サイト |
| `4` | スタンバイ（求人版） | B | 反応は中程度 |
| `5` | グーグル（求人版） | B | 検索経由、反応は中程度 |
| `7` | Q-mate（indeed） | B | 反応は中程度 |
| その他 | - | B | デフォルト |

### 実装ファイル

`src/lib/mock-data.ts` (630-640行目): `sourcePriorityRules`
`src/app/tasks/page.tsx` (55-68行目): `getApproachPriority`関数

### 優先度の意味

| 優先度 | 意味 | 対応期限 |
|:---|:---|:---|
| S | 最優先 | 本日中に対応必須 |
| A | 高 | できれば本日中に対応 |
| B | 中 | 今週中に対応 |
| C | 低 | フォロー・定期連絡 |

### 手動変更

優先度は自動判定されますが、手動で変更することも可能です。
- 変更は`priorities` stateで管理（画面内でのみ有効）
- データソースには保存されない（プロトタイプのため）

## 計算ロジック

### KPI計算

#### 登録→初回率

```
登録→初回率 = (初回済み人数 / 登録人数) * 100
```

- **登録人数**: `mockCandidates`の全件数
- **初回済み人数**: ステータスが`first_contact_done`以降の人数
- **実装ファイル**: `src/app/page.tsx` (98-101行目)

#### 初回→面接率

```
初回→面接率 = (面接人数 / 初回済み人数) * 100
```

- **初回済み人数**: ステータスが`first_contact_done`以降の人数
- **面接人数**: ステータスが`interviewing`, `offer`, `closed_won`の人数
- **実装ファイル**: `src/app/page.tsx` (102-104行目)

#### 面接→成約率

```
面接→成約率 = (成約人数 / 面接人数) * 100
```

- **面接人数**: ステータスが`interviewing`, `offer`, `closed_won`の人数
- **成約人数**: ステータスが`closed_won`の人数
- **実装ファイル**: `src/app/page.tsx` (105行目, 110行目)

#### 成約単価

```
成約単価 = 成約額合計 / 成約人数
```

- **成約額合計**: `mockMemberStats`から`totalSales`を集計
- **成約人数**: ステータスが`closed_won`の人数
- **実装ファイル**: `src/app/page.tsx` (113行目)

### 予算達成率

```
予算達成率 = (売上 / 予算) * 100
```

- **売上**: `mockMemberStats`から`totalSales`を集計
- **予算**: `totalBudget`（定数: 29,000,000円）
- **実装ファイル**: `src/app/page.tsx` (82行目, 250行目)

### 不足金額

```
不足金額 = 予算 - 売上 - Aヨミ - Bヨミ
```

- **予算**: `totalBudget`
- **売上**: `totalSales`
- **Aヨミ**: `totalYomiA`
- **Bヨミ**: `totalYomiB`
- **実装ファイル**: `src/app/page.tsx` (85行目)

### プロセス別集計

各プロセス（リード管理、面談フェーズなど）の件数と割合を計算：

```
プロセス件数 = 該当ステータスの求職者数
プロセス割合 = (プロセス件数 / 全求職者数) * 100
```

- **実装ファイル**: `src/app/page.tsx` (90-94行目)
- **ステータス→プロセス変換**: `processStatusLabels`を使用

## データの整合性を保つためのルール

### 1. 関連データの連動更新

**原則**: 関連するデータは常に同期を保つ

**例**:
- 面接の担当者を変更したら、求職者の担当者も更新
- 求職者のステータスを`closed_won`に変更したら、`contracts`にレコードを作成

### 2. データソースの優先順位

1. **変更されたデータ**（`candidateStatuses`, `interviewStatuses`など）: 最優先
2. **元のデータ**（`mock-data.ts`）: 変更されていない場合のフォールバック

### 3. 重複防止

- 成約レコードの作成時: 既存レコードがあるか確認
- タイムラインイベント: 一意のIDを生成（`tl-${Date.now()}-${interview.id}`形式）

## AIエージェント向けの判断基準

### ステータス変更時

1. **自動処理の確認**: `closed_won`になったら、必ず`contracts`にレコードを作成
2. **重複防止**: 既存レコードがあるか確認してから作成

### 担当者変更時

1. **連動更新**: 面接の担当者を変更したら、求職者の担当者も更新
2. **タイムライン記録**: 担当者変更時は必ずタイムラインイベントを作成

### タイムラインイベント作成時

1. **必須項目**: `id`, `candidate_id`, `event_type`, `title`, `description`, `created_at`を必ず設定
2. **保存先**: `localStorage`に保存（`timelineEvents`キー）
3. **一意のID**: `tl-${Date.now()}-${interview.id}`形式で生成

### 計算ロジック実装時

1. **データソース**: 常に`mockCandidates`や`mockMemberStats`から計算
2. **ゼロ除算防止**: 分母が0の場合は0を返す
3. **精度**: パーセンテージは小数点第1位まで表示

## 関連ドキュメント

- [システム目的と設計思想](./SYSTEM_PURPOSE.md) - システムの基本方針
- [画面仕様とビジネスロジック](./SCREEN_LOGIC.md) - 各画面の詳細仕様
- [データフローと状態管理](./DATA_FLOW.md) - データの流れ
