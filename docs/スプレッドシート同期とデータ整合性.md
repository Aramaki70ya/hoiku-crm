# スプレッドシート同期とデータ整合性

## 起きうる問題「名前と住所・電話・職種がバラバラになった」

同期（GAS の syncNewCandidates / syncAllContactUpdate / backfillRegisteredAt）で **既存の求職者** を「シートの値で更新」するとき、次のようなずれがあると **別人のデータで上書き** してしまいます。

- **シートの行と ID の対応が崩れている**  
  例: 行を挿入・削除したあと、ID 列を手で直し忘れている／別の行の ID がコピーされている
- **1行目がヘッダーではない**  
  例: 1行目が「求職者一覧」などのタイトルで、2行目が本当のヘッダー → 列の対応がずれ、名前列に住所が入るなどする
- **列の順序や列名が想定と違う**  
  連絡先一覧の列順・列名が変わっていると、名前・住所・電話などが別の項目として取り込まれる

その結果、「名前は A さんなのに住所・電話が B さん」のように、求職者情報が混在した状態になることがあります。

---

## 再発防止（実装済み）

同期処理では、**既存候補を更新する前に「シートの氏名」と「DB の氏名」を照合**しています。

- **一致する場合**  
  これまでどおり、その行の内容で登録日・連絡先・年齢などを更新します。
- **一致しない場合**  
  その行の更新は行わずスキップし、API のレスポンスの `errors` に  
  「氏名不一致のため更新をスキップしました。シート「〇〇」／DB「〇〇」。行ずれ・ID列の誤りがないか確認してください。」  
  と出ます。

シートの 1 行目は **必ずヘッダー行**（担当者・媒体・ID・氏名・電話番号…）にし、行の挿入・削除をしたあとは **ID 列が正しくその行の人を指しているか** を確認してから同期をかけてください。

---

## すでに壊れてしまったデータを直すには

- **バックアップや export がある場合**  
  その時点の candidates に戻すか、正しいデータだけを選んでインポートし直す。
- **スプレッドシートが正しい情報源の場合**  
  1. シートの 1 行目をヘッダーにそろえ、ID 列と各行の対応が正しいことを確認する。  
  2. 同期では「氏名不一致のためスキップ」が出た行は、シート側の ID または氏名を直してから再度同期する。  
  3. DB 側で明らかに別人のデータが入っている行は、**正しい行のデータだけ**をシートで整えたうえで、該当 ID の行が「氏名一致」になるようにしてから同期するか、管理画面から手で修正する。

DB を一括で上書きする機能は用意していません。誤って上書きしないよう、同期は「氏名一致」した行だけ更新する仕様になっています。
