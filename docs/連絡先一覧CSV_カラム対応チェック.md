# 連絡先一覧 CSV とコードの対応チェック

対象ファイル: `元データ/求職者管理 - 連絡先一覧 .csv`

## ヘッダー（1行目）の比較

| # | CSVの列名（実際） | コードで使用 | 用途（candidates へのマッピング） |
|---|-------------------|-------------|-----------------------------------|
| 1 | 担当者 | ✅ | consultant_id（名前→users.id） |
| 2 | 媒体 | ✅ | source_id（名前→sources.id） |
| 3 | 日付 | ✅ | registered_at（登録日） |
| 4 | 曜日 | ✅ | （参照のみ・DBにはなし） |
| 5 | 時間 | ✅ | （参照のみ・DBにはなし） |
| 6 | 電話予約 | ✅ | （参照のみ・DBにはなし） |
| 7 | ステータス | ✅ | status（新規/初回済み/成約/NG等→内部値） |
| 8 | ID | ✅ | id（求職者ID・一意） |
| 9 | 氏名 | ✅ | name |
| 10 | 電話番号 | ✅ | phone（正規化して保存） |
| 11 | メールアドレス | ✅ | email |
| 12 | 生年月日 | ✅ | birth_date |
| 13 | 年齢 | ✅ | age（125/126は除外） |
| 14 | 都道府県 | ✅ | prefecture |
| 15 | 市区町村 | ✅ | address |
| 16 | 正・パ | ✅ | desired_employment_type |
| 17 | 保有資格 | ✅ | qualification |
| 18 | 応募職種 | ✅ | desired_job_type |
| 19 | 応募・気になる求人 | ✅ | （参照のみ・memoに含める場合は要対応） |
| 20 | 備考 | ✅ | memo（フォロー中断理由と結合可） |
| 21 | フォロー中断理由 | ✅ | memo（備考と結合） |
| (末尾) | （空） | - |  trailing comma のみ・無視してOK |

## 判定結果

- **列順・列名**: このCSVの1行目は、`csv-parser.ts` の `CsvRow` / `rowToCandidateForSync` が想定しているヘッダーと**一致しています**。
- **GAS**: スプレッドシート「連絡先一覧」の1行目をヘッダーとして `row[header] = values[j]` でオブジェクト化しているため、**同じ列構成のシートであればこのCSVと同様に扱えます**。

## 注意事項

1. **1行目は必ずヘッダー**  
   タイトル行を入れず、先頭行を「担当者,媒体,日付,...」にすること。行ずれで名前と住所が混在する不具合の原因になります。
2. **ID・氏名**  
   ID と氏名は同期時の「同一人物」判定に使います。既存候補の更新では「シートの氏名」と「DBの氏名」が一致する行だけ更新します。
3. **ステータス**  
   CSVで使われている値（新規・連絡中・初回済み・成約・NG・意向回収など）は `spreadsheetStatusMap` で内部ステータスに変換されます。未定義の値は `new` になります。

## CSV と DB の突き合わせチェック（名前・連絡先・年齢など）

**連絡先一覧 CSV** と **DB の candidates** を ID で突き合わせ、氏名・電話・メール・年齢・住所・職種などが一致しているかを一括チェックできます。

### 実行方法

```bash
# hoiku-crm ディレクトリで
cd hoiku-crm
node scripts/check-csv-vs-db.js
```

CSV のパスを指定する場合:

```bash
node scripts/check-csv-vs-db.js "../元データ/求職者管理 - 連絡先一覧 .csv"
```

### 前提

- `.env.local` に `NEXT_PUBLIC_SUPABASE_URL` と `SUPABASE_SERVICE_ROLE_KEY` が設定されていること
- デフォルトの CSV は `元データ/求職者管理 - 連絡先一覧 .csv`（リポジトリ親ディレクトリ）

### 結果の見方

- **一致**: CSV と DB の該当項目が同じ
- **不一致**: 氏名・電話・メール・年齢・住所・雇用形態・資格・応募職種のいずれかが異なる（最大50件をコンソールに表示、全件は `check-csv-vs-db-result.json` に保存）
- **CSV にのみ存在**: その ID が DB に未登録
- **DB にのみ存在**: その ID が CSV にない

不一致のうち「氏名が別人」になっている場合は、以前報告のあった「名前と住所・電話がバラバラになった」ようなデータずれの可能性があります。該当 ID の DB を CSV（正）に合わせて手修正するか、同期時の氏名一致チェックで上書きを避けてからシートを整えて再同期してください。

---

## 不一致を CSV の内容で一括修正する

**CSV を正**として、不一致になっている候補者レコードを DB で一括更新できます。

### 実行方法

```bash
cd hoiku-crm
# 更新内容だけ確認（DB は変更しない）
node scripts/fix-csv-vs-db.js --dry-run
# 実際に DB を更新
node scripts/fix-csv-vs-db.js
```

CSV パスを指定する場合:

```bash
node scripts/fix-csv-vs-db.js "../元データ/求職者管理 - 連絡先一覧 .csv"
```

### 注意

- **同一 ID が CSV に複数行ある場合**は、**最後の行の内容で上書き**されます。同一 ID で別人が混在している場合は、CSV 側で ID を分けるか、どちらを正とするか決めてから実行してください。
- 更新する項目: 氏名・電話・メール・生年月日・年齢・都道府県・住所・雇用形態・保有資格・応募職種・備考・ステータス。

---

## 更新履歴

- 初回: `求職者管理 - 連絡先一覧 .csv` の実ヘッダーとコードの対応を照合し、一致を確認。
- CSV と DB の突き合わせスクリプト `scripts/check-csv-vs-db.js` の実行手順を追加。
