# ダッシュボード「面接」「成約」の表示ロジック（誰でもわかる説明）

営業進捗テーブルの **面接** と **成約** の数字が、どこからどう計算されて出ているかを説明します。

---

## 1. 数字は「2通り」のどちらかで決まる

表示される面接数・成約数は、**次のどちらか一方**だけが使われます。

| 条件 | 使われる数字 |
|------|----------------|
| **その月の「月次マージシート」データが1件でもある** | **マージシート由来**（API `/api/metrics` が返す値） |
| **その月のマージシートデータが0件** | **DB由来**（下記のルールでアプリ内で計算した値） |

- マージシートにデータがある月は、**画面の数字はすべてマージシートの値**です。DBの面接・成約データは参照されません。
- マージシートにデータがない月だけ、DBのルール（下記）で計算した数字が表示されます。

---

## 2. DBで「面接」の数字を出すときのロジック

「その月に **面接フェーズ** に入った求職者が何人か」を、**担当者ごとのユニーク人数**で数えています。

### 2.1 「面接フェーズ」とは

次の3つのステータスの**どれかに、その月に変わった人**だけを数えます。

- 面接日程調整中
- 面接確定済
- 面接実施済（結果待ち）

※ その月に「内定獲得」「成約」「内定辞退」に変わっただけの人は、**面接数には入れません**（成約数には入れます）。  
　例：1月に面接→2月に成約した人 → 2月の「面接」にはカウントせず、「成約」だけカウント。

### 2.2 どこから「その月に面接フェーズに入った人」を拾うか

**status_history（ステータス変更履歴）のみ** を使います。

- いつ・誰が・どのステータスに変わったかが入っているテーブル。
- ここから「その月」に、上記3つのどれか（面接日程調整中 / 面接確定済 / 面接実施済（結果待ち））に**変わった**求職者IDを集める。

※ **interviews テーブル（面接の日時）は使いません**。面接の実施日ではなく、**ステータスが変わったタイミング**で期間を絞ります。

### 2.3 担当者ごとの「面接」の数字

- status_history から集めた「求職者IDの集合」のうち、**その担当者が担当している求職者**だけを数えた数が、その担当者の **面接** の数字です。
- 合計は、全担当者の面接数を足した値です（同じ求職者が複数担当にカウントされることはありません。1人につき1担当者だけ）。

---

## 3. DBで「成約」の数字を出すときのロジック

「その月に **成約（内定承諾）** になった求職者が何人か」を、**担当者ごとのユニーク人数**で数えています。

### 3.1 どこから「その月に成約した人」を拾うか（2ソースを合算）

次の **2種類のデータ** をあわせて、「その月に成約した求職者」のリストを作ります。同じ人は1回だけカウントします。

1. **status_history**
   - 「内定承諾（成約）」に**その月に**変わった求職者IDを集める。

2. **contracts（契約）**
   - 契約日（contracted_at / accepted_date など）が**その月**に入っている契約に紐づく求職者IDを集める。

→ 上記1と2を **合算**（重複は1人1カウント）した「求職者IDの集合」が、「その月に成約した人」の全体です。

### 3.2 担当者ごとの「成約」の数字

- その集合のうち、**その担当者が担当している求職者**だけを数えた数が、その担当者の **成約** の数字です。
- 表示上は「成約 ≤ 面接」になるように、面接数以下にクリップして表示しています。

---

## 4. 数字が「違う気がする」ときに確認すること

1. **その月はマージシートを使っているか**
   - マージシートにその月のデータが入っている → 画面は **マージシートの値**。DBの面接・成約とは別ソースなので、一致しないことがあります。

2. **DBを使っている月の場合**
   - **面接**  
     - status_history に「面接日程調整中 / 面接確定済 / 面接実施済（結果待ち）」への変更が**その月**で記録されているか。  
     - 記録がない操作（昔の変更や手動更新など）は反映されません。  
     - ※ interviews テーブル（面接の日時）は使いません。
   - **成約**  
     - status_history に「内定承諾（成約）」への変更がその月で記録されているか、または contracts にその月の契約があるか。

3. **担当の一致**
   - 求職者の「担当者」が正しく設定されていないと、別の担当者の数字にカウントされたり、誰にもカウントされなかったりします。

---

## 5. まとめ（一言で）

- **面接** = その月に **status_history** で「面接日程調整中 / 面接確定済 / 面接実施済（結果待ち）」のどれかに変わった人を、担当者ごとのユニーク人数で表示（マージシートがある月はマージシートの値）。interviews テーブルは使わない。
- **成約** = その月に成約した人を、**status_history と contracts** の両方から拾って合算し、担当者ごとのユニーク人数で表示（マージシートがある月はマージシートの値）。
