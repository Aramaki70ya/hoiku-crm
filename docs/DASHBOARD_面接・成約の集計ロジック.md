# ダッシュボード「面接」「成約」の表示ロジック（誰でもわかる説明）

営業進捗テーブルの **面接** と **成約** の数字が、どこからどう計算されて出ているかを説明します。

---

## 1. 数字は「2通り」のどちらかで決まる

表示される面接数・成約数は、**次のどちらか一方**だけが使われます。

| 条件 | 使われる数字 |
|------|----------------|
| **その月の「月次マージシート」データが1件でもある** | **マージシート由来**（API `/api/metrics` が返す値） |
| **その月のマージシートデータが0件** | **DB由来**（下記のルールでアプリ内で計算した値） |

- マージシートにデータがある月は、**画面の数字はすべてマージシートの値**です。DBの面接・成約データは参照されません。
- マージシートにデータがない月だけ、DBのルール（下記）で計算した数字が表示されます。

---

## 2. DBで「面接」の数字を出すときのロジック

「その月に **初めて面接確定済・実施済** に入った求職者が何人か」を、**担当者ごとのユニーク人数**で数えています。  
**過去に一度でも面接フェーズに入ったことがある求職者は除外**します（初回面接のみカウント）。  
**無効化された面接（is_voided=true）を持つ候補者も除外**します。

### 2.1 「面接確定済・実施済」とは（カウント対象）

次の2つのステータスの**どれかに、その月に変わった人**だけを数えます。

- **面接確定済**
- **面接実施済（結果待ち）**

⚠️ **「面接日程調整中」は除外**されます。これにより以下のケースがカウントされなくなります：
- 面接日程調整段階での辞退
- 設定後キャンセル（調整中に戻った場合）
- 調整中のまま未成立

※ その月に「内定獲得」「成約」「内定辞退」に変わっただけの人は、**面接数には入れません**（成約数には入れます）。  
　例：1月に面接→2月に成約した人 → 2月の「面接」にはカウントせず、「成約」だけカウント。

### 2.2 「初回面接のみカウント」の仕組み

1. まず、**対象月より前**の status_history を走査し、以下のステータスに変わったことがある求職者IDを「過去に面接経験あり」リストとして集める。
   - 面接確定済
   - 面接実施済（結果待ち）
   - 内定獲得（承諾確認中）
   - 内定承諾（成約）
   - 内定辞退
   
   ※ **面接日程調整中のみの場合は「面接経験あり」としない**（日程調整しただけでキャンセルになったケースを考慮）。  
   ※ この基準はマージシート利用時の API 側（`INTERVIEW_SET_STATUSES`）と統一。
2. 次に、**対象月内**に上記2.1の2つのステータス（**面接確定済 / 面接実施済（結果待ち）**）に変わった求職者IDを集める。
3. 手順2のうち、手順1の「過去に面接経験あり」リストに含まれる求職者を**除外**する。
4. さらに、**無効化された面接（interviews.is_voided=true）を持つ候補者を除外**する。

→ 残った求職者が「今月初めて面接になった人」です。

### 2.3 どこから「その月に面接フェーズに入った人」を拾うか

**status_history（ステータス変更履歴）のみ** を使います。

- いつ・誰が・どのステータスに変わったかが入っているテーブル。
- ここから「その月」に、上記2つのどれか（**面接確定済 / 面接実施済（結果待ち）**）に**変わった**求職者IDを集める。
- さらに、その求職者に紐づく **interviews テーブル** を参照し、`is_voided=false` の面接が期間内に存在するか確認する。

※ **interviews テーブルの日時は使いません**が、**無効化フラグ（is_voided）は確認**します。  
※ 面接の実施日ではなく、**ステータスが変わったタイミング**で期間を絞ります。

### 2.4 担当者ごとの「面接」の数字

- status_history から集めた「求職者IDの集合」（過去に面接経験がある人・無効化された面接を持つ人を除外済み）のうち、**その担当者が担当している求職者**だけを数えた数が、その担当者の **面接** の数字です。
- 合計は、全担当者の面接数を足した値です（同じ求職者が複数担当にカウントされることはありません。1人につき1担当者だけ）。

### 2.5 面接の無効化機能

ダッシュボードの面接数をクリックすると、その担当者の面接対象者一覧が表示されます。  
ここで個別に面接を**無効化**できます。

**無効化すると：**
- 面接レコードに `is_voided=true` フラグが立つ
- 候補者ステータスが「面接日程調整中」へ戻る
- 面接設定件数から除外される
- 面接レコード自体は削除されず、履歴として残る
- 無効化理由（void_reason）が記録される

**無効化する想定ケース：**
- 面接日程調整段階での辞退
- 設定後キャンセル
- 調整中のまま未成立
- その他、面接設定件数にカウントすべきでないケース

---

## 3. DBで「成約」の数字を出すときのロジック

「その月に **成約（内定承諾）** になった求職者が何人か」を、**担当者ごとのユニーク人数**で数えています。

### 3.1 どこから「その月に成約した人」を拾うか（2ソースを合算）

次の **2種類のデータ** をあわせて、「その月に成約した求職者」のリストを作ります。同じ人は1回だけカウントします。

1. **status_history**
   - 「内定承諾（成約）」に**その月に**変わった求職者IDを集める。

2. **contracts（契約）**
   - 契約日（contracted_at / accepted_date など）が**その月**に入っている契約に紐づく求職者IDを集める。

→ 上記1と2を **合算**（重複は1人1カウント）した「求職者IDの集合」が、「その月に成約した人」の全体です。

### 3.2 担当者ごとの「成約」の数字

- その集合のうち、**その担当者が担当している求職者**だけを数えた数が、その担当者の **成約** の数字です。
- 表示上は「成約 ≤ 面接」になるように、面接数以下にクリップして表示しています。

---

## 4. 数字が「違う気がする」ときに確認すること

1. **その月はマージシートを使っているか**
   - マージシートにその月のデータが入っている → 画面は **マージシートの値**。DBの面接・成約とは別ソースなので、一致しないことがあります。

2. **DBを使っている月の場合**
   - **面接**  
     - status_history に「**面接確定済 / 面接実施済（結果待ち）**」への変更が**その月**で記録されているか。  
     - **「面接日程調整中」のみの場合は面接数にカウントされません**（調整段階辞退・未成立を除外）。
     - **過去に面接経験がある人は除外**される。対象月より前に「面接確定済」以降のステータス（面接確定済 / 面接実施済（結果待ち） / 内定獲得 / 内定承諾 / 内定辞退）への変更履歴がある人はカウントされない。「面接日程調整中」のみの場合は面接経験ありとしない。
     - **無効化された面接（interviews.is_voided=true）を持つ候補者は除外**される。
     - 記録がない操作（昔の変更や手動更新など）は反映されません。  
     - ※ interviews テーブルの日時は使いませんが、無効化フラグ（is_voided）は確認します。
   - **成約**  
     - status_history に「内定承諾（成約）」への変更がその月で記録されているか、または contracts にその月の契約があるか。

3. **マージシートを使っている月の場合**
   - **面接**
     - 対象月の `stg_member_monthly` で `interview_flag = TRUE` かつステータスが**面接確定済・実施済**の求職者をカウント。
     - **面接日程調整中のみの場合は除外**（調整段階辞退・未成立を除外）。
     - **過去月に面接経験がある人は除外**される。対象月より前の月の `stg_member_monthly` で同じ条件に該当していた求職者はカウントされない。

4. **担当の一致**
   - 求職者の「担当者」が正しく設定されていないと、別の担当者の数字にカウントされたり、誰にもカウントされなかったりします。

---

## 5. まとめ（一言で）

- **面接** = その月に **初めて** 面接確定済・実施済に入った人（過去に「面接確定済」以降の経験がない人のみ。面接日程調整中のみは面接経験としない。**面接日程調整中のみは除外**。無効化された面接を持つ人も除外）を、担当者ごとのユニーク人数で表示。マージシートがある月はマージシートの値（同じ基準で過去月の面接経験者を除外）。interviews テーブルの日時は使わないが、無効化フラグ（is_voided）は確認。
- **成約** = その月に成約した人を、**status_history と contracts** の両方から拾って合算し、担当者ごとのユニーク人数で表示（マージシートがある月はマージシートの値）。

## 6. 面接の無効化機能

ダッシュボードから面接を「無効化」することで、面接設定件数から除外できます。

### 6.1 使い方

1. ダッシュボードの営業進捗テーブルで、各メンバーの「面接」数字をクリック
2. その担当者の面接対象者一覧がモーダルで表示される
3. 各行の「無効化」ボタンで個別に除外できる

### 6.2 無効化の効果

- `interviews.is_voided = true` フラグが立つ
- 候補者ステータスが「面接日程調整中」へ自動的に戻る
- 面接設定件数から即座に除外される
- 面接レコードは削除されず、履歴として残る（is_voided=true として記録）
- 無効化理由（void_reason）が記録される

### 6.3 無効化する想定ケース

- 面接日程調整段階での辞退
- 設定後キャンセル（調整中に戻った）
- 調整中のまま未成立
- その他、面接設定件数にカウントすべきでないと判断したケース
