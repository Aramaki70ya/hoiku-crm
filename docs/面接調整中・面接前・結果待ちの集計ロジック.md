# 面接調整中・面接前・結果待ちの集計ロジック

ダッシュボード（営業進捗サマリ）の「面接調整中／面接前／結果待ち」がどこから来ているか、DBと画面ロジックの整理です。

---

## 1. DBに専用カラムはあるか

**「面接調整中」「面接前」「結果待ち」のカラムはDBにはありません。** 画面側で **interviews テーブルと candidates テーブルの既存カラム** から算出しています。

### 使っているテーブル・カラム

| テーブル | カラム | 用途 |
|----------|--------|------|
| **interviews** | `status` | `rescheduling`=調整中, `scheduled`=予定, `completed`=実施済。これで「調整中／面接前／結果待ち」を判定 |
| **interviews** | `project_id` | どの案件の面接か |
| **interviews** | `start_at` | 面接日時（※集計ロジック変更後は「今の状態」表示にのみ使用し、期間フィルタには使わない方針も可） |
| **candidates** | `status` | 結果待ちのとき「内定（offer）でない」かどうかの判定に使用 |
| **projects** | `phase`, `expected_amount`, `probability` | 本人返事待ち・ヨミ表示用 |

- **candidates.status** はレガシー値（`new`, `contacting`, `interviewing`, `offer` など）で保存されています。画面では `status-mapping.ts` の `LEGACY_STATUS_MAP` で新しいラベルに変換して表示しています。
- **interviews.status** の CHECK 制約: `'scheduled', 'completed', 'cancelled', 'rescheduling'` のいずれか。

---

## 2. 画面に表示する数値のロジック（ダッシュボード）

営業進捗サマリの「面接状況」テーブル（面接調整中／面接前／結果待ち／本人返事待ち）は、次のルールで **案件（project）単位** に分類しています。

- 対象: 各担当者（consultant_id）に紐づく **求職者 → その求職者の案件（projects）**。
- その案件に紐づく **面接（interviews）** を 1件以上持つものだけが、いずれか1つに分類される（持たない案件は一覧に出ない）。

### 分類ルール（優先順）

1. **面接調整中**  
   その案件に **status = `rescheduling`** の面接が 1件以上ある → 調整中。
2. **面接前**  
   上記以外で、**status = `scheduled`** の面接が 1件以上あり、かつ **status = `completed`** の面接が 0件 → 面接前。
3. **結果待ち**  
   上記以外で、**status = `completed`** の面接が 1件以上あり、かつ **求職者（candidate）の status ≠ `offer`** → 結果待ち。
4. **本人返事待ち**  
   **project.phase = `offer`** または **candidate.status = `offer`** の案件 → 本人返事待ち（上記と重複して同じ案件が載ることもあり）。

同一求職者で複数案件がある場合は、`project.updated_at` が新しい 1件だけを代表して表示する実装になっています。

### 以前の「反映されない」原因（期間フィルタ）

- **変更前**: 「面接状況」の集計に **選択期間内の面接だけ**（`interviews.start_at` が期間内）を使っていました。
- そのため「今月」を選んでいると、**面接日が今月の案件だけ**が対象で、来月・先月の面接の案件は一覧に出ていませんでした。
- **変更後**: 面接状況（調整中／面接前／結果待ち）は **全期間の面接** を使って「今の状態」で判定するように変更しています。これで、面接日が何月であっても、現在の状態が反映されます。

---

## 3. 確認用クエリ（Supabase）

「なぜこの案件が 調整中／前／結果待ち に出ないか」を確認するときは、以下で DB の状態を見られます。

```sql
-- ある求職者IDの案件と面接状況
SELECT
  p.id AS project_id,
  p.candidate_id,
  p.phase AS project_phase,
  i.id AS interview_id,
  i.status AS interview_status,
  i.start_at
FROM projects p
LEFT JOIN interviews i ON i.project_id = p.id
WHERE p.candidate_id = '20206138'  -- 求職者IDを変更
ORDER BY p.updated_at DESC, i.start_at DESC;
```

- **面接調整中** になる条件: 上で `interview_status = 'rescheduling'` の行が 1件以上あること。
- **面接前** になる条件: `scheduled` が 1件以上、`completed` が 0件。
- **結果待ち** になる条件: `completed` が 1件以上、かつ `candidates.status != 'offer'`（candidates と JOIN して確認）。

---

## 4. 求職者ステータス変更で面接に反映する

求職者詳細画面で、**名前の横のステータスドロップダウン**（「初回連絡中」などが表示されているボタン）を次のいずれかに変更して保存すると、その求職者に紐づく「代表」面接 1 件の `interviews.status` が自動で同期されます。

| 求職者ステータスに選んだ値     | 同期後の interviews.status |
|--------------------------------|-----------------------------|
| 面接日程調整中                 | rescheduling（調整中）     |
| 面接確定済                     | scheduled（実施中）        |
| 面接実施済（結果待ち）         | completed（実施済）        |

- 対象になるのは、その求職者の案件（projects）に紐づく面接のうち、**面接日が一番新しい 1 件**（キャンセル以外）です。面接が 1 件もない場合は何もしません。
- これにより、**求職者詳細のステータスを変えるだけ**で、面接一覧・ダッシュボードの「面接調整中／面接前／結果待ち」にも反映されます。

---

## 5. まとめ

| 項目 | 内容 |
|------|------|
| DB に「面接調整中／前／結果待ち」の列があるか | **ない**。interviews.status 等から算出。 |
| 画面の数値の元 | interviews.status（rescheduling / scheduled / completed）と candidates.status、projects.phase。 |
| 反映されない主な原因（修正済み） | 以前は「選択期間内の面接」だけが対象だったため、面接日が別月だと出ていなかった。→ 全期間の面接で「今の状態」を出すように変更済み。 |
| 画面上で変える場所 | 求職者詳細の**名前横のステータスドロップダウン**（「初回連絡中」等のボタン）を「面接日程調整中」「面接確定済」「面接実施済（結果待ち）」のいずれかに変更して保存すると、面接側にも自動反映される。 |
